name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ---------------------------------------------------------------------------
  # Python linting — ruff check + ruff format
  # ---------------------------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ruff-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-ruff-

      - run: pip install ruff
      - run: ruff check .
      - run: ruff format --check .

  # ---------------------------------------------------------------------------
  # Python tests — pytest with coverage
  # ---------------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-dev-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-dev-

      - run: pip install -e ".[dev]"
      - run: pytest --cov=cli --cov-report=term-missing -v

  # ---------------------------------------------------------------------------
  # Python type checking — mypy strict
  # ---------------------------------------------------------------------------
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-dev-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-dev-

      - run: pip install -e ".[dev]"
      - run: mypy cli/ --ignore-missing-imports

  # ---------------------------------------------------------------------------
  # Frontend build — TypeScript compile + Vite production build
  # Catches type errors and broken imports before they reach the Docker build.
  # ---------------------------------------------------------------------------
  frontend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          # actions/setup-node resolves the cache path relative to the root of
          # the repository, so point it at the frontend lockfile explicitly.
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build dashboard
        run: npm run build

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          # Retain the artifact for 7 days — useful for inspecting build output
          # without re-triggering CI, and consumed by the docker-build job below.
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Docker build — verify the multi-stage Dockerfile compiles end-to-end.
  # Runs after frontend-build succeeds so we know the Node stage will pass.
  # Does NOT push the image; this is a pure correctness check.
  # ---------------------------------------------------------------------------
  docker-build:
    runs-on: ubuntu-latest
    needs: [frontend-build]
    steps:
      - uses: actions/checkout@v4

      # Enable BuildKit's cache exporter so repeated CI runs reuse layer cache.
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: false
          # Tag the local image so it can be referenced by name in later steps
          # if needed (e.g., a smoke-test `docker run`).
          tags: infrakt:ci-${{ github.sha }}
          # Persist the layer cache between workflow runs using the GitHub
          # Actions cache backend. `mode=max` caches all intermediate layers,
          # not just the final stage, which is critical for the multi-stage
          # build to benefit from caching the npm install and pip install layers.
          cache-from: type=gha
          cache-to: type=gha,mode=max
