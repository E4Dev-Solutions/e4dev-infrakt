# Design: Perfect Initial Deployment

## Problem

Deploying infrakt to a fresh VPS requires too many manual steps and hit several bugs during the first production deployment. The setup script only handles Docker and the container on port 8000 — no HTTPS, no Caddy, manual SSH key copying, manual API key retrieval.

## Goals

1. Fix known deployment bugs (Caddyfile wipe, Docker socket permissions)
2. One-command deployment: `setup-vps.sh --domain infrakt.example.com --token ghp_xxx`
3. Automatic HTTPS via Caddy sidecar container
4. Private GHCR image support via GitHub PAT
5. Tear down and redeploy on prod-01 to verify

## Architecture

```
Internet → :443 (Caddy sidecar) → :8000 (infrakt container)
```

`docker-compose.prod.yml` runs two services:
- `caddy` — handles HTTPS (ports 80/443), reverse proxies to `infrakt:8000`
- `infrakt` — the app (no host port exposed)

## Phase 1: Commit Pending Fixes

Two uncommitted changes already in working tree:

1. **Dockerfile** — `usermod -aG docker infrakt` so self-update can access Docker socket
2. **cli/core/provisioner.py** — preserve existing Caddyfile domain blocks during provisioning

Commit, push, verify CD pipeline triggers.

## Phase 2: Add Caddy Sidecar

### docker-compose.prod.yml changes

```yaml
services:
  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    restart: unless-stopped
    depends_on:
      - infrakt

  infrakt:
    image: ghcr.io/e4dev-solutions/e4dev-infrakt:latest
    # No host port — only accessible via caddy
    expose:
      - "8000"
    volumes:
      - infrakt-data:/home/infrakt/.infrakt
      - ${SSH_KEY_PATH:-/opt/infrakt/ssh}:/home/infrakt/.ssh:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose.prod.yml:/opt/infrakt/docker-compose.prod.yml:ro
    environment:
      - CORS_ORIGINS=${CORS_ORIGINS:-}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET:-}
      - COMPOSE_FILE=/opt/infrakt/docker-compose.prod.yml
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

volumes:
  infrakt-data:
  caddy-data:
  caddy-config:
```

### Caddyfile (generated by setup script)

```
{DOMAIN} {
    reverse_proxy infrakt:8000
}
```

## Phase 3: Improve setup-vps.sh

### New parameters

```
setup-vps.sh --domain <domain> --token <github-pat>
```

- `--domain` (required) — domain for HTTPS, e.g. `infrakt.e4dev.app`
- `--token` (required) — GitHub PAT with `read:packages` scope for private GHCR

### What the script does

1. Install Docker (if needed)
2. `docker login ghcr.io` with the PAT
3. Create `/opt/infrakt/` directory structure
4. Download `docker-compose.prod.yml` from repo (using PAT for auth since private)
5. Generate `Caddyfile` with the domain
6. Generate `.env` with webhook secret
7. `docker compose pull && up -d`
8. Wait for health check
9. Print API key from container logs
10. Print next-steps (DNS, webhook setup)

### Private repo file download

Since the repo is private, `curl` from raw.githubusercontent.com won't work without auth. The script will use the GitHub API:

```bash
curl -H "Authorization: token ${TOKEN}" \
  -H "Accept: application/vnd.github.v3.raw" \
  "https://api.github.com/repos/E4Dev-Solutions/e4dev-infrakt/contents/docker-compose.prod.yml?ref=main"
```

## Phase 4: Test on prod-01

1. SSH into prod-01
2. Stop and remove current infrakt containers and volumes
3. Remove `/opt/infrakt/` contents
4. Run the new `setup-vps.sh` with domain + token
5. Verify HTTPS works
6. Verify self-update webhook works
7. Add prod-01 as a managed server in infrakt and provision it

## Out of Scope

- Caddy sidecar does NOT handle app proxy routes — those are managed by the host Caddy installed during `infrakt server provision`
- No changes to how infrakt provisions/deploys apps on servers
- No Terraform or infrastructure-as-code
